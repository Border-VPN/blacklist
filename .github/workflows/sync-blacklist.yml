name: Sync blacklist from upstream

on:
    schedule:
        - cron: "0 0 * * *" # every 24 hours at 00:00 UTC
    workflow_dispatch: {}

jobs:
    sync:
        runs-on: ubuntu-latest
        env:
            # Set this secret to 'true' to push directly to main (dangerous).
            # If unset or not 'true' the workflow will create a PR instead.
            PUSH_DIRECT: false
        steps:
            - name: Checkout this repository
              uses: actions/checkout@v4
              with:
                  ref: main

            - name: Checkout upstream repository (BEDOLAGA-DEV/VPN-BLACKLIST)
              uses: actions/checkout@v4
              with:
                  repository: "BEDOLAGA-DEV/VPN-BLACKLIST"
                  path: upstream-bedolaga

            - name: Checkout upstream repository (Blin4ickUSE/ban-vpn)
              uses: actions/checkout@v4
              with:
                  repository: "Blin4ickUSE/ban-vpn"
                  path: upstream-blin4ick

            - name: Checkout upstream repository (nerioff1337/bedolagam-ban)
              uses: actions/checkout@v4
              with:
                  repository: "nerioff1337/bedolagam-ban"
                  path: upstream-nerioff

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.x"

            - name: Merge blacklists
              run: |
                  python scripts/merge_blacklist.py --source upstream-bedolaga/blacklist.txt
                  python scripts/merge_blacklist.py --source upstream-blin4ick/blacklist.txt
                  python scripts/merge_blacklist.py --source upstream-nerioff/blacklist.txt

            - name: Validate merged blacklist
              run: |
                  python scripts/validate_blacklist.py

            - name: Commit and push directly to main (if enabled)
              if: env.PUSH_DIRECT == 'true'
              uses: EndBug/add-and-commit@v9
              with:
                  message: "chore: sync blacklist from upstream repositories"
                  add: "blacklist.txt"
                  push: true

            - name: Create Pull Request if changes (default behavior)
              if: env.PUSH_DIRECT != 'true'
              uses: peter-evans/create-pull-request@v8
              with:
                  commit-message: "chore: sync blacklist from upstream repositories"
                  branch: "auto/sync-blacklist-${{ github.run_id }}"
                  title: "Sync blacklist"
                  body: |
                      This PR merges the upstream `blacklist.txt` from `BEDOLAGA-DEV/VPN-BLACKLIST`, `Blin4ickUSE/ban-vpn` and `nerioff1337/bedolagam-ban` into this repository, removes duplicates and normalizes entries.

                      Automated job: schedule every 24 hours.

                  labels: "auto-sync"
